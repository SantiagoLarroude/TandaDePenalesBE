# TandaDePenales

## Quick Start (Backend)

Prereq: use Node 22 via nvm-windows.

1) Select Node 22:

- `nvm use 22.11.0`

2) Install tooling + Functions deps:

- `npm install`
- `npm --prefix functions install`

3) Build + run emulators:

- `npm --prefix functions run build`
- `npx firebase-tools emulators:start --only functions`

Recommended (prevents accidental production access for Firestore/Auth):

- `npx firebase-tools emulators:start --only functions,firestore,auth`

This repo contains:

- A Unity client (Unity 2021.3.45f2).
- A Firebase Cloud Functions backend in the [functions/](functions/) folder.

## Backend (Firebase Functions) — Setup + What Broke Previously

### 1) Problem summary

Running the Functions emulator previously failed (and sometimes `npm run build` failed) due to **version incompatibilities between**:

- The Firebase Functions runtime libraries used by the backend (`firebase-functions`, `firebase-admin`).
- The Firebase CLI used to start emulators (`firebase-tools`).
- The active Node.js version on the machine (nvm-windows was installed, but different terminals used different Node versions).

### 2) Root cause analysis

#### A) TypeScript build failed due to wrong `firebase-functions` import paths

Symptoms (from `npm --prefix functions run build`):

- `TS2305: Module 'firebase-functions' has no exported member 'setGlobalOptions'`
- `TS2307: Cannot find module 'firebase-functions/https'`

Cause:

- The backend is using **2nd-gen (v2) Functions APIs** (e.g., `setGlobalOptions`, `onRequest` from v2), but it was importing them from the older module paths.

Fix:

- Updated imports to the v2 module paths in [functions/src/index.ts](functions/src/index.ts):
  - `firebase-functions/v2`
  - `firebase-functions/v2/https`

Why this works:

- `firebase-functions` v2 API surface is published under the `/v2` entrypoints; TypeScript resolves the correct declarations and compilation succeeds.

#### B) `npm install` failed due to peer dependency conflict

Symptom:

- `ERESOLVE unable to resolve dependency tree`
  - `firebase-functions@4.9.0` requires `firebase-admin` `^10 || ^11 || ^12`
  - but the project uses `firebase-admin@^13.6.0`

Cause:

- `firebase-admin@13.x` and `firebase-functions@4.x` are not compatible in npm’s dependency resolver.

Fix:

- Aligned to compatible versions in [functions/package.json](functions/package.json) by using `firebase-functions@^7.0.0` together with `firebase-admin@^13.6.0`.

Why this works:

- `firebase-functions@7` supports newer `firebase-admin` major versions, so npm can resolve the dependency tree cleanly.

#### C) Emulator failed because the Firebase CLI was too old for the backend’s Functions version

Symptom (from `npx firebase-tools emulators:start --only functions`):

- `FirebaseError: Failed to parse build specification`

Cause:

- Older `firebase-tools` (the CLI) can’t parse the newer Functions “build spec” generated by `firebase-functions@7`.

Fix:

- Upgraded the repo-pinned Firebase CLI to `firebase-tools@^15.2.1` in [package.json](package.json).

Why this works:

- `firebase-tools@15` understands the newer Functions discovery/build metadata produced by `firebase-functions@7`.

#### D) Node version mismatch (nvm-windows)

Symptoms:

- `firebase-tools@15` refuses to run on Node 18 (it requires Node >= 20).
- Different terminals were using different Node versions (Node 18 vs Node 22), causing confusing “it worked yesterday” behavior.

Fix:

- Use Node 22 via nvm-windows before running emulator commands.

Why this works:

- It satisfies `firebase-tools@15` engine requirements and keeps the toolchain consistent.

### 3) Fixes applied (exact changes)

- Updated Functions v2 imports in [functions/src/index.ts](functions/src/index.ts).
- Upgraded backend runtime libs in [functions/package.json](functions/package.json) (notably `firebase-functions@^7.0.0` alongside `firebase-admin@^13.6.0`).
- Pinned a compatible Firebase CLI in [package.json](package.json): `firebase-tools@^15.2.1`.
- Standardized on Node 22 for local dev (see commands below).

### 4) Final working configuration

Prereqs:

- Windows + nvm-windows installed.
- Node 22 available via nvm (this repo was validated with `22.11.0`).
- Java installed is recommended if you run Firestore/PubSub emulators (Functions-only does not require Java).

Commands:

1. Select Node 22:
   - `nvm use 22.11.0`
2. Install root tooling (pins `firebase-tools`):
   - `npm install`
3. Install and build Functions:
   - `npm --prefix functions install`
   - `npm --prefix functions run build`
4. Run Functions emulator:
   - `npx firebase-tools emulators:start --only functions`

Recommended (avoid accidental production access):

- If your Functions code reads/writes Firestore/Auth, start emulators for them too:
  - `npx firebase-tools emulators:start --only functions,firestore,auth`

### 5) Notes / warnings to prevent future issues

- Prefer `npx firebase-tools ...` (repo-pinned) over any globally installed `firebase-tools`.
- If you see warnings like “Firestore emulator is not running, calls will affect production”, it’s real: start the Firestore emulator too.
- If emulators exit with code 1 after you press Ctrl+C, that’s expected; it’s a clean shutdown signal.
